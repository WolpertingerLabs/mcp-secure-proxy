services:
  remote-server:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: mcp-secure-proxy-remote
    restart: unless-stopped

    # Bind to localhost only — the container is NOT reachable from the network.
    # Only the MCP proxy on the same host can connect.
    ports:
      - "127.0.0.1:9999:9999"

    # Secrets are loaded from .env on the host and injected as environment
    # variables into the container. They exist only in container process memory.
    # See .env.example for the expected format.
    env_file:
      - .env

    # Mount config and keys read-only. The host path defaults to the repo-local
    # .mcp-secure-proxy directory (created by `npm run setup`).
    # IMPORTANT: config.json must have "host": "0.0.0.0" in the remote section
    # so Docker port forwarding works. The 127.0.0.1 in ports: above is what
    # restricts external access.
    volumes:
      - ${MCP_CONFIG_DIR:-./.mcp-secure-proxy}:/config:ro

    # Immutable container filesystem
    read_only: true

    # Scratch space if Node needs temp files (none expected, but safety net)
    tmpfs:
      - /tmp:noexec,nosuid,size=10m

    # Drop ALL Linux capabilities — the server needs none
    cap_drop:
      - ALL

    # Prevent privilege escalation
    security_opt:
      - no-new-privileges:true
